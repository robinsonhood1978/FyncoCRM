<#include "/t/_c.html" />
<@layout>
                <div class="mdk-drawer-layout__content page">



                    <div class="container-fluid  page__heading-container">
                        <div class="page__heading">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="#"><i class="material-icons icon-20pt">home</i></a></li>
                                    <li class="breadcrumb-item">Clients</li>
                                    <li class="breadcrumb-item active" aria-current="page">Leads</li>
                                </ol>
                            </nav>
                            <h1 class="m-0"><#if method=='add'>New<#else>Edit</#if> Lead</h1>
                        </div>
                    </div>




                    <div class="container-fluid page__container">
                        <div class="card card-form">
                        <div class="col-lg-12 card-body" style="padding-bottom: 10px;font-size: 30px; background-color: #C0C0C0;">
                                    <p><strong class="headings-color">General Information</strong></p>
                                    <!-- <p class="text-muted">Edit the client general information.</p> -->
                                    
                                </div>
                            <div class="row no-gutters">
                                
                                <div class="col-lg-12 card-form__body card-body">
                                	<div class="row">
                                    	<div class="col">
                                            <div class="form-group">
                                                <label for="lname">Title</label>
                                                <!-- <input type="text" class="form-control" name="client.title" id="title" value="${(client.title)!}"> -->
                                                <select id="title" data-toggle="select" data-minimum-results-for-search="-1" class="form-control">
		                                            <option value="Mr" >
		                                                Mr
		                                            </option>
		                                            <option value="Miss" >
		                                                Miss
		                                            </option>
		                                            <option value="Mrs" >
		                                                Mrs
		                                            </option>
		                                            <option value="Ms" >
		                                                Ms
		                                            </option>
		                                        </select>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fname">Gender</label>
                                                <select id="gender" data-toggle="select" data-minimum-results-for-search="-1" class="form-control">
		                                            <option value="1" data-avatar-src="/t/assets/images/avatar/male.jpg">
		                                                Male
		                                            </option>
		                                            <option value="0" data-avatar-src="/t/assets/images/avatar/female.jpg">
		                                                Female
		                                            </option>
		                                            <option value="2" data-avatar-src="/t/assets/images/avatar/dfavatar.png">
		                                                Unknown
		                                            </option>
		                                        </select>
                                            </div>
                                        </div>
                                    </div>
                                 	<div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fname">First name</label>
                                                <input type="text" class="form-control" name="client.first_name" id="first_name" value="${(client.first_name)!}">
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="lname">Last name</label>
                                                <input type="text" class="form-control" name="client.last_name" id="last_name" value="${(client.last_name)!}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                    	<div class="col">
                                            <div class="form-group">
                                                <label for="fname">Preferred Name</label>
                                                <input type="text" class="form-control" name="client.prefered_name" id="prefered_name" value="${(client.prefered_name)!}" >
                                            </div>
                                        </div>
                                        <div class="col">
                                             <div class="form-group">
		                                        <label for="birthday">Date of Birth</label>
		                                        <input id="birthday" type="date" class="form-control" value="<#if client??&&client.birthday??>${(client.birthday)?string('yyyy-MM-dd')!}</#if>" placeholder="date: 00/00/0000"  maxlength="10">
		                                    </div>
                                        </div>
                                    </div>
                                   <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fname">Personal Email</label>&nbsp;&nbsp;&nbsp;&nbsp;<i id="add_email" class="material-icons">add_circle_outline</i>
                                                 <div id="emails">
                                                	<div id="inputemail">
                                                	<div id="divemail" class="search-form search-form--light">
                                                <input type="text" class="form-control" name="email">
                                                <button onclick="RemoveEmail('[email_index]')" id="bt_email" style="display:none;" class="btn" type="button" role="button"><i class="material-icons">close</i></button>
                                            </div>
                                                		
                                            		</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="lname">Work Email</label>
                                                <input type="text" class="form-control" name="client.work_email" id="work_email" value="${(client.work_email)!}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fname">Mobile</label>&nbsp;&nbsp;&nbsp;&nbsp;
                                                <i id="add_mobile" class="material-icons">add_circle_outline</i>
                                                <div id="mobiles">
                                                	<div id="inputmobile">
                                                	<div id="divmobile" class="search-form search-form--light">
                                                <input class="form-control" type="text" onkeypress="return event.charCode >= 48 && event.charCode <= 57" name="mobile" pattern="[0-9]" value="">
                                                <button onclick="RemoveMobile('[mobile_index]')" id="bt_mobile" style="display:none;" class="btn" type="button" role="button"><i class="material-icons">close</i></button>
                                            </div>
                                            
	                                                	
	                                                </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="lname">Work Phone</label>
                                                <input type="text" class="form-control" name="client.work_phone" id="work_phone" value="${(client.work_phone)!}">
                                            </div>
                                        </div>
                                    </div>
                                   
                                    <div class="row">
                                        
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="lname">Home Phone</label>
                                                <input type="text" class="form-control" name="client.home_phone" id="home_phone" value="${(client.home_phone)!}">
                                            </div>
                                        </div>
                                        <div class="col">
                                       		<div class="form-group">
                                                <label for="lname">Wechat</label>
                                                <input type="text" class="form-control" name="client.wechat" id="wechat" value="${(client.wechat)!}">
                                            </div>
 
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fname">Comments</label><br/>
                                                <textarea class="comment" id="comments" name="client.comments" rows="3" cols="60">${(client.comments)!}</textarea>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>

 

                        
                        <div class="text-right mb-5">
                        <input type="hidden" id="clientid" value="${(client.id)!}">
                         <input type="hidden" id="avatar_url" value="${(client.avatar)!}">
                            <button class="btn btn-success" onClick="return SaveLead('${method}');">Save</button>
                        </div>
                    </div>


                </div>
                <!-- // END drawer-layout__content -->
                <script>
                var client_avatar = '${(client.avatar)!}';
                function copyNode(nodeid){
            		
            		var mobile_index = document.getElementsByName("mobile").length;
            		var email_index = document.getElementsByName("email").length;
            		
            		var sourceNode = document.getElementById(nodeid); // 获得被克隆的节点对象 
            		var clonedNode = sourceNode.cloneNode(true); // 克隆节点 
            		//console.log(sourceNode.innerHTML)
            		//console.log('--------------------')
            		$node = $(clonedNode);
            		$node.find('button[id="bt_mobile"]').css("display","block");
            		$node.find('div[id="divmobile"]').attr("id","divmobile_"+mobile_index);
            		$node.find('button[id="bt_email"]').css("display","block");
            		$node.find('div[id="divemail"]').attr("id","divemail_"+email_index);
            		var html = $node.html();  
            		html = html.replaceAll('[mobile_index]',mobile_index);  
            		html = html.replaceAll('[email_index]',email_index); 
            		
            		//console.log(html)
            		var newnode = parseDom(html);
            		sourceNode.parentNode.appendChild($(newnode)[0]); // 在父节点插入克隆的节点 
            	}
                function RemoveMobile(id){
                	$('#divmobile_'+id).remove();
                }
                function RemoveEmail(id){
                	$('#divemail_'+id).remove();
                }
                String.prototype.replaceAll = function(search, replacement) {
            	    var target = this;
            	    return target.split(search).join(replacement);
            	};
                function parseDom(arg) {

                	var objE = document.createElement("div");

                	objE.innerHTML = "<div>"+arg+"</div>";

                	return objE.childNodes;

                }
                $(function () { 
                	
                	$("#add_mobile").on('click',function(e){
                		//$('#mobiles').append($('#inputmobile').html());
                		copyNode("inputmobile");
                	});
                	$("#add_email").on('click',function(e){
                		copyNode("inputemail");
                	});
                	if('${method}'=='edit'){
                		var gender = '${(client.gender)!}';
                    	$('#gender').val(gender).trigger('change');
                    	//$("#gender").select2();
                	}
                	$("#edit_avatar").on('click',function(e){
                		var url = '/add_avatar3?url='+client_avatar;
                		layer.open({
                			type: 2,
                			title: 'Edit client avatar',
                			fixed: false, //不固定
                			maxmin: true,
                		    shadeClose: true, //点击遮罩关闭层
                			area: ['60%', '85%'],
                			content: url ,
                			success:function(layero,index){
                	        },
                	        end:function(){
                	        	document.getElementById('iframe_avatar').contentWindow.document.getElementById('profile-pic').src=$('#avatar_url').val();
                	        	//alert($('#avatar_url').val());
                	        }
                		});
                	});
                })
                function formatDate(date) {
                    var d = new Date(date),
                        month = '' + (d.getMonth() + 1),
                        day = '' + d.getDate(),
                        year = d.getFullYear();

                    if (month.length < 2) 
                        month = '0' + month;
                    if (day.length < 2) 
                        day = '0' + day;

                    return [day, month, year].join('/');
                }
                if('${method}'=='edit'){
                	var mobiles = '${(client.mobile)!}';
                	if(mobiles!=''){
	                	var mobileArray = JSON.parse(mobiles);
	                	for(var i=1;i<mobileArray.length;i++){
	                		copyNode("inputmobile");
	                	}
	                	var mobile = document.getElementsByName("mobile");
	    				for(var i=0;i<mobileArray.length;i++){
	    					mobile[i].value=mobileArray[i];
	    				}  
                	} 
                	
                	var emails = '${(client.personal_email)!}';
                	if(emails!=''){
	                	var emailArray = JSON.parse(emails);
	                	for(var i=1;i<emailArray.length;i++){
	                		copyNode("inputemail");
	                	}
	                	var email = document.getElementsByName("email");
	    				for(var i=0;i<emailArray.length;i++){
	    					email[i].value=emailArray[i];
	    				}  
                	} 
                }
function SaveLead(method){
                	var title=$('#title').val();
    				var gender=$('#gender').val();
    				var first_name=$('#first_name').val();
    				var last_name=$('#last_name').val();
    				var prefered_name=$('#prefered_name').val();
    				var birthday=formatDate($('#birthday').val());
    				var work_phone=$('#work_phone').val();
    				var mobileArr=[];
    		        $("input[name='mobile']").each(function(){
    		        	mobileArr.push($(this).val());
    		        })
    		        var mobile = JSON.stringify(mobileArr);
    		        
    		        var emailArr=[];
    		        $("input[name='email']").each(function(){
    		        	emailArr.push($(this).val());
    		        })
    		        var email = JSON.stringify(emailArr);
    		        
    				var home_phone=$('#home_phone').val();
    				var wechat=$('#wechat').val();
    				
    				var work_email=$('#work_email').val();
    				var comments=$('#comments').val();
				var clientid=$('#clientid').val();
				//var avatar=document.getElementById('iframe_avatar').contentWindow.document.getElementById('avatar_url').value;
				var avatar = $('#avatar_url').val();
				//alert(avatar);
				var url = "/lead/";
				if(method=='add')url+="save";
				else url+="update";

				$.post(url, {"client.id":clientid,"client.title":title,"client.gender":gender,"client.first_name":first_name,"client.last_name":last_name,"client.prefered_name":prefered_name,
					"birthday":birthday,"client.work_phone":work_phone,"client.mobile":mobile,"client.home_phone":home_phone,"client.personal_email":email,"client.work_email":work_email,
					"client.comments":comments,"client.avatar":avatar}, function(data) {
					if(data.code==1){
					 	mlayer.open({
						    content: 'Fail',
						    btn: 'Got it'
						  });
						return false;
					}
					else{ 
						//sessionStorage.setItem("fynco_email", vemail); 
						mlayer.open({
						    content: 'Success',
						    btn: 'Got it',
						    yes: function(){
						    	location.href="/lead";
						      }
						  });
					}
					return false;
				}, "json");
				return false;
	

}
</script>
</@layout>