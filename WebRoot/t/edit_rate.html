<#include "/t/_s.html" />
<@layout>
                <div class="mdk-drawer-layout__content page">



                    <div class="container-fluid page__container">
                        
                        <div class="card card-form">
                        <div class="col-lg-12 card-body" style="padding-bottom: 10px;font-size: 30px; background-color: #C0C0C0;">
                                    <p><strong class="headings-color">Loan Structure</strong></p>
                                    <!-- <p class="text-muted">Edit the loan information.</p> -->
                                    
                                </div>
                            <div class="row no-gutters">
          
                                <div class="col-lg-12 card-form__body card-body">
                                <div id="loans">
	                                	<div id="loan">
	                                	<div id="loan_[node_index]">
	                                	<div class="card-header bg-white d-flex align-items-center" style="padding-bottom: 1px;">
                               <p><strong class="headings-color">Edit Rates</strong></p>
                                
                            </div>
                                	
                                 	<div class="row">
                                        
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="lname">Loan Amount</label>
                                                <input class="form-control" name="loan_amount" value="" readonly>
                                                <input type="hidden" class="form-control" name="order_id" value="">
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label for="fname">Commission Rate</label>
                                                <input type="number" type="text" class="form-control" name="commission_rate" value="">
                                            </div>
                                        </div>
                                    </div>
                                    
                                   
                                   
                                    
                                    
                                    
                                </div>
                                </div>
                            </div>
                            
                            </div>
                            </div>
                        </div>
                    
                        
                        
                        <div class="text-right mb-5">
                        	
                        	 <input type="hidden" id="appid" value="${(application.id)!}">
                        	 <button class="btn btn-success" onClick="return SaveLoan('${method}');">Save Rates</button>
                        	
                        	 
                            
                        </div>
                    </div>


                </div>
                <!-- // END drawer-layout__content -->
                <script>
                //dannel modify
                
               
                
                String.prototype.replaceAll = function(search, replacement) {
            	    var target = this;
            	    return target.split(search).join(replacement);
            	};
                function parseDom(arg) {

                	var objE = document.createElement("div");

                	objE.innerHTML = "<div>"+arg+"</div>";

                	return objE.childNodes;

                }

                $(function () { 
                	function copyNode(nodeid){
                		var node_index = document.getElementsByName("loan_amount").length;
                		
                		var sourceNode = document.getElementById(nodeid); // 获得被克隆的节点对象 
                		var clonedNode = sourceNode.cloneNode(true); // 克隆节点 
                		//console.log(sourceNode.innerHTML)
                		//console.log('--------------------')
                		$node = $(clonedNode);
                		
                		
                		
                		var html = $node.html().replaceAll('[node_index]',node_index);  
                		
                		var newnode = parseDom(html);
                		sourceNode.parentNode.appendChild($(newnode)[0]); // 在父节点插入克隆的节点 
                	}
                	
                	
                	
                	
                	if('${method}'=='editrate'){
                		
	                	var loan = '${(application.loan)!}';
	         
	                	if(loan!=''){
		                	var loanArray = JSON.parse(loan);
		                	for(var i=1;i<loanArray.length;i++){
		                		copyNode("loan");
		                	}
		                	
		    				var loan_amount = document.getElementsByName("loan_amount");
		    				var order_id = document.getElementsByName("order_id");
		    				var commission_rate = document.getElementsByName("commission_rate");
		    				
		    				for(var i=0;i<loanArray.length;i++){
		    					loan_amount[i].value=loanArray[i]['loan_amount'];
		    					order_id[i].value=loanArray[i]['order_id'];
		    					//if(loanArray[i]['commission_rate']!=undefined)
		    					if(loanArray[i].hasOwnProperty("commission_rate"))
		    						commission_rate[i].value=loanArray[i]['commission_rate'];
		    					
		    				}  
	                	} 
                	}
                })

                
function SaveLoan(method){
				var appid = $('#appid').val();
				var url = "/application/";
				url+="saverate";


				var loanArray = new Array();
				
				var order_id = document.getElementsByName("order_id");
				var commission_rate = document.getElementsByName("commission_rate");
				
				
				
				for(var i=0;i<order_id.length;i++){
					if(order_id[i].value!=''){
						alert(order_id[i].value)
						loanArray.push({"application_id":appid,"order_id":order_id[i].value,"commission_rate":commission_rate[i].value});
					}
				} 
				var jsonLoan = JSON.stringify( loanArray );
				//alert(jsonLoan)
				$.post(url, {"appid":appid,
					"loan":jsonLoan}, function(data) {
					if(data.code==1){
					 	mlayer.open({
						    content: 'Fail',
						    btn: 'Got it'
						  });
						return false;
					}
					else{ 
						mlayer.open({
						    content: 'Success',
						    btn: 'Got it',
						    yes: function(){
						    	var index = parent.layer.getFrameIndex(window.name);
					 	        parent.layer.close(index);
						      }
						  }); 
						
					}
					return false;
				}, "json"); 
				return false;
	

}
</script>
</@layout>